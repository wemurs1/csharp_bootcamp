# Run when commits are pushed to main
trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: 'Release'

steps:
  - task: UseDotNet@2
    inputs:
      version: '9.x'
    displayName: Set up .NET 9

  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      command: 'build'
      projects: '**/*.csproj'
      arguments: --configuration $(buildConfiguration)

  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: 'test'
      projects: 'tests/TemplateApp.Api.IntegrationTests/TemplateApp.Api.IntegrationTests.csproj'
      arguments: '--configuration $(buildConfiguration)'
      nobuild: true

  # setup-azd@1 needs to be manually installed in your organization
  # if you can't install it, you can use the below bash script to install azd
  # and remove this step
  - task: setup-azd@1
    displayName: Install azd

  # azd delegate auth to az to use service connection with AzureCLI@2
  - pwsh: |
      azd config set auth.useAzCliAuth "true"
    displayName: Configure AZD to Use AZ CLI Authentication.

  - task: AzureCLI@2
    displayName: Provision Infrastructure
    inputs:
      azureSubscription: azconnection
      scriptType: bash
      scriptLocation: inlineScript
      keepAzSessionActive: true
      inlineScript: |
        azd provision --no-prompt
    env:
      AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
      AZURE_ENV_NAME: $(AZURE_ENV_NAME)
      AZURE_LOCATION: $(AZURE_LOCATION)
      AZURE_KEYCLOAK_PASSWORD: $(AZURE_KEYCLOAK_PASSWORD)
      AZURE_POSTGRES_USER: $(AZURE_POSTGRES_USER)
      AZURE_POSTGRES_PASSWORD: $(AZURE_POSTGRES_PASSWORD)

  - task: AzureCLI@2
    displayName: Deploy Application
    inputs:
      azureSubscription: azconnection
      scriptType: bash
      scriptLocation: inlineScript
      keepAzSessionActive: true
      inlineScript: |
        azd deploy --no-prompt
    env:
      AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
      AZURE_ENV_NAME: $(AZURE_ENV_NAME)
      AZURE_LOCATION: $(AZURE_LOCATION)
      AZURE_KEYCLOAK_PASSWORD: $(AZURE_KEYCLOAK_PASSWORD)
      AZURE_POSTGRES_USER: $(AZURE_POSTGRES_USER)
      AZURE_POSTGRES_PASSWORD: $(AZURE_POSTGRES_PASSWORD)
